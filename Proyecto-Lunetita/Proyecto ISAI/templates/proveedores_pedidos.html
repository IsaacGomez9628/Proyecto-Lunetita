<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Proveedores y Pedidos - Comics POS</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Axios for API requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
      .logo-shape::before {
        content: "";
        display: inline-block;
        width: 20px;
        height: 20px;
        background-color: black;
        margin-right: 10px;
        clip-path: polygon(0 0, 100% 0, 100% 100%, 50% 70%, 0 100%);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Navbar -->
    <div class="bg-white shadow-md py-4 px-6 flex justify-between items-center">
      <a href="/" class="font-black text-2xl flex items-center logo-shape"
        >COMICS</a
      >

      <button class="md:hidden text-2xl">‚ò∞</button>

      <ul class="hidden md:flex items-center space-x-8">
        <li>
          <a
            href="/productos"
            class="font-medium text-gray-700 hover:text-gray-900"
            >Productos</a
          >
        </li>
        <li>
          <a
            href="/empleados"
            class="font-medium text-gray-700 hover:text-gray-900"
            >Empleados</a
          >
        </li>
        <li>
          <a
            href="/proveedores"
            class="font-medium text-gray-700 hover:text-gray-900 relative pb-1 after:content-[''] after:absolute after:w-full after:h-0.5 after:bg-red-600 after:bottom-0 after:left-0"
            >Proveedores</a
          >
        </li>
        <li>
          <a
            href="/clientes"
            class="font-medium text-gray-700 hover:text-gray-900"
            >Clientes</a
          >
        </li>
      </ul>

      <div class="flex items-center cursor-pointer">
        <div
          class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center font-bold mr-2"
        >
          A
        </div>
        <span class="font-medium mr-1">Admin</span>
        <span class="text-xs">‚ñº</span>
      </div>
    </div>

    <!-- Main content -->
    <div class="flex-1 p-6 max-w-7xl mx-auto w-full">
      <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Proveedores y Pedidos</h1>
        <button
          id="addProviderBtn"
          class="bg-red-600 text-white px-4 py-2 rounded font-semibold hover:bg-red-700 transition"
        >
          + Agregar Proveedor
        </button>
      </div>

      <!-- Tab Navigation -->
      <div class="flex border-b border-gray-300 mb-6">
        <button
          id="proveedoresTab"
          class="px-5 py-3 font-medium relative text-red-600 after:content-[''] after:absolute after:w-full after:h-0.5 after:bg-red-600 after:bottom-0 after:left-0"
        >
          Proveedores
        </button>
        <button
          id="pedidosTab"
          class="px-5 py-3 font-medium text-gray-700 hover:text-gray-900"
        >
          Pedidos a Proveedores
        </button>
      </div>

      <!-- Search and Filters -->
      <div class="bg-white p-5 rounded-lg shadow-sm mb-6">
        <div class="flex mb-4">
          <input
            type="text"
            id="searchInput"
            class="flex-1 border border-gray-300 rounded-l-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            placeholder="Buscar proveedores..."
          />
          <button
            id="searchBtn"
            class="bg-red-600 text-white px-5 py-2 rounded-r-lg hover:bg-red-700 transition"
          >
            üîç
          </button>
        </div>

        <div class="flex flex-wrap gap-4">
          <div class="flex items-center">
            <span class="font-semibold text-sm mr-2">Categor√≠a:</span>
            <select
              id="categoryFilter"
              class="border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            >
              <option value="all">Todos</option>
              <option value="comics">Comics</option>
              <option value="manga">Manga</option>
              <option value="merch">Merchandising</option>
            </select>
          </div>

          <div class="flex items-center">
            <span class="font-semibold text-sm mr-2">Estado:</span>
            <select
              id="statusFilter"
              class="border border-gray-300 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            >
              <option value="all">Todos</option>
              <option value="1">Activo</option>
              <option value="2">Inactivo</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Tab Content -->
      <div id="proveedoresContent" class="block">
        <!-- Providers Grid -->
        <div
          id="proveedoresGrid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <!-- Provider cards will be loaded here dynamically -->
        </div>

        <!-- Pagination -->
        <div class="flex justify-center mt-8">
          <div class="flex space-x-1">
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              ¬´
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-red-600 text-white"
            >
              1
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              2
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              3
            </button>
            <button
              class="w-9 h-9 flex items-center justify-center rounded bg-white shadow-sm hover:bg-gray-100 transition"
            >
              ¬ª
            </button>
          </div>
        </div>
      </div>

      <div id="pedidosContent" class="hidden">
        <!-- Orders section -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden">
          <div
            class="flex justify-between items-center p-5 border-b border-gray-200"
          >
            <h2 class="text-lg font-semibold">Pedidos a Proveedores</h2>
            <button
              id="addOrderBtn"
              class="bg-green-600 text-white px-4 py-2 rounded font-semibold hover:bg-green-700 transition"
            >
              + Nuevo Pedido
            </button>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Pedido #
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Proveedor
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Fecha
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Total
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Estado
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Acciones
                  </th>
                </tr>
              </thead>
              <tbody
                id="pedidosTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Order rows will be loaded here dynamically -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for adding/editing providers -->
    <div
      id="providerModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 id="modalTitle" class="text-xl font-bold">Agregar Proveedor</h2>
          <button
            id="closeProviderModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <form id="providerForm" class="space-y-4">
          <input type="hidden" id="providerId" value="" />

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="providerName"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Nombre *</label
              >
              <input
                type="text"
                id="providerName"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                required
              />
            </div>

            <div>
              <label
                for="providerEmail"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Email *</label
              >
              <input
                type="email"
                id="providerEmail"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                required
              />
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="providerPhone"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Tel√©fono</label
              >
              <input
                type="text"
                id="providerPhone"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="providerDelivery"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Tiempo de entrega (d√≠as)</label
              >
              <input
                type="number"
                id="providerDelivery"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                min="1"
              />
            </div>
          </div>

          <div>
            <label
              for="providerAddress"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Direcci√≥n</label
            >
            <input
              type="text"
              id="providerAddress"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label
                for="providerCity"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Ciudad</label
              >
              <input
                type="text"
                id="providerCity"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="providerState"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Estado</label
              >
              <input
                type="text"
                id="providerState"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>

            <div>
              <label
                for="providerZip"
                class="block text-sm font-medium text-gray-700 mb-1"
                >C√≥digo Postal</label
              >
              <input
                type="text"
                id="providerZip"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label
              for="providerNotes"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Notas</label
            >
            <textarea
              id="providerNotes"
              rows="3"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            ></textarea>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="cancelProviderBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2 hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for creating orders -->
    <div
      id="orderModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-4xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Nuevo Pedido a Proveedor</h2>
          <button
            id="closeOrderModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <form id="orderForm" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="orderProvider"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Proveedor *</label
              >
              <select
                id="orderProvider"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                required
              >
                <option value="">Seleccionar proveedor</option>
                <!-- Providers will be loaded here dynamically -->
              </select>
            </div>

            <div>
              <label
                for="orderExpectedDate"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Fecha estimada de llegada</label
              >
              <input
                type="date"
                id="orderExpectedDate"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              />
            </div>
          </div>

          <div>
            <label
              for="orderNotes"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Notas</label
            >
            <textarea
              id="orderNotes"
              rows="2"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
            ></textarea>
          </div>

          <div>
            <div class="flex justify-between items-center mb-2">
              <h3 class="font-medium">Productos</h3>
              <button
                type="button"
                id="addProductBtn"
                class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition"
              >
                + Agregar Producto
              </button>
            </div>

            <div class="overflow-x-auto border border-gray-200 rounded">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Producto
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Cantidad
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Precio Unitario
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Subtotal
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Acciones
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="orderDetailsList"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Product rows will be added here dynamically -->
                  <tr id="noProductsRow">
                    <td
                      colspan="5"
                      class="px-4 py-3 text-sm text-gray-500 text-center"
                    >
                      No hay productos agregados
                    </td>
                  </tr>
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      Subtotal:
                    </td>
                    <td
                      class="px-4 py-3 text-sm font-medium"
                      id="orderSubtotal"
                    >
                      $0.00
                    </td>
                    <td></td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      IVA (16%):
                    </td>
                    <td class="px-4 py-3 text-sm font-medium" id="orderTax">
                      $0.00
                    </td>
                    <td></td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-bold"
                    >
                      Total:
                    </td>
                    <td class="px-4 py-3 text-sm font-bold" id="orderTotal">
                      $0.00
                    </td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="cancelOrderBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2 hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
            >
              Crear Pedido
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for adding products to order -->
    <div
      id="productModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-md p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Agregar Producto</h2>
          <button
            id="closeProductModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <form id="productForm" class="space-y-4">
          <div>
            <label
              for="productSelect"
              class="block text-sm font-medium text-gray-700 mb-1"
              >Producto *</label
            >
            <select
              id="productSelect"
              class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
              required
            >
              <option value="">Seleccionar producto</option>
              <!-- Products will be loaded here dynamically -->
            </select>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="productQuantity"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Cantidad *</label
              >
              <input
                type="number"
                id="productQuantity"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                min="1"
                value="1"
                required
              />
            </div>

            <div>
              <label
                for="productPrice"
                class="block text-sm font-medium text-gray-700 mb-1"
                >Precio Unitario *</label
              >
              <input
                type="number"
                id="productPrice"
                class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-transparent"
                min="0.01"
                step="0.01"
                required
              />
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="cancelProductBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded mr-2 hover:bg-gray-300 transition"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
            >
              Agregar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Details Modal for viewing order details -->
    <div
      id="detailsModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
    >
      <div class="bg-white rounded-lg w-full max-w-4xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 id="detailsTitle" class="text-xl font-bold">
            Detalles del Pedido
          </h2>
          <button
            id="closeDetailsModal"
            class="text-gray-500 hover:text-gray-700 text-2xl"
          >
            &times;
          </button>
        </div>

        <div class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">N√∫mero de Pedido</p>
              <p id="detailsNumber" class="font-medium">-</p>
            </div>

            <div>
              <p class="text-sm text-gray-500">Estado</p>
              <p id="detailsStatus" class="font-medium">-</p>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p class="text-sm text-gray-500">Proveedor</p>
              <p id="detailsProvider" class="font-medium">-</p>
            </div>

            <div>
              <p class="text-sm text-gray-500">Fecha de Orden</p>
              <p id="detailsDate" class="font-medium">-</p>
            </div>
          </div>

          <div>
            <p class="text-sm text-gray-500">Notas</p>
            <p id="detailsNotes" class="font-medium">-</p>
          </div>

          <div>
            <h3 class="font-medium mb-2">Productos</h3>

            <div class="overflow-x-auto border border-gray-200 rounded">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Producto
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Cantidad
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Precio Unitario
                    </th>
                    <th
                      scope="col"
                      class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                    >
                      Subtotal
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="detailsProductList"
                  class="bg-white divide-y divide-gray-200"
                >
                  <!-- Product details will be loaded here dynamically -->
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      Subtotal:
                    </td>
                    <td
                      class="px-4 py-3 text-sm font-medium"
                      id="detailsSubtotal"
                    >
                      $0.00
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-medium"
                    >
                      IVA (16%):
                    </td>
                    <td class="px-4 py-3 text-sm font-medium" id="detailsTax">
                      $0.00
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="3"
                      class="px-4 py-3 text-right text-sm font-bold"
                    >
                      Total:
                    </td>
                    <td class="px-4 py-3 text-sm font-bold" id="detailsTotal">
                      $0.00
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div class="flex justify-end pt-4">
            <button
              type="button"
              id="closeDetailsBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API URL
      const API_BASE_URL = "http://127.0.0.1:8000"; // Ajusta esta URL seg√∫n tu configuraci√≥n
      const API_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // Token de ejemplo, ajusta seg√∫n tu configuraci√≥n

      console.log("API Base URL:", API_BASE_URL);

      // Agrega esto para probar
      axios
        .get("/proveedores/")
        .then((response) => {
          console.log("¬°Conexi√≥n exitosa!", response.data);
        })
        .catch((error) => {
          console.error(
            "Error de conexi√≥n:",
            error.response?.data || error.message
          );
        });

      // Configuration for axios
      axios.defaults.baseURL = API_BASE_URL;
      axios.defaults.headers.common["Authorization"] = `Bearer ${API_TOKEN}`;

      // A√±ade estos interceptores para depuraci√≥n
      axios.interceptors.request.use(
        (request) => {
          console.log("Enviando solicitud a:", request.url);
          console.log("Datos enviados:", request.data);
          console.log("M√©todo:", request.method);
          console.log("Headers:", request.headers);
          return request;
        },
        (error) => {
          console.error("Error en la solicitud:", error);
          return Promise.reject(error);
        }
      );

      axios.interceptors.response.use(
        (response) => {
          console.log("Respuesta recibida de:", response.config.url);
          console.log("Datos recibidos:", response.data);
          console.log("C√≥digo de estado:", response.status);
          return response;
        },
        (error) => {
          console.error("Error en la respuesta:", error);
          if (error.response) {
            console.error("Datos del error:", error.response.data);
            console.error("Estado del error:", error.response.status);
          }
          return Promise.reject(error);
        }
      );

      // Global application state
      let currentProviders = [];
      let currentOrders = [];
      let currentProducts = [];
      let orderDetails = [];
      let selectedProviderId = null;

      // DOM Elements
      const proveedoresTab = document.getElementById("proveedoresTab");
      const pedidosTab = document.getElementById("pedidosTab");
      const proveedoresContent = document.getElementById("proveedoresContent");
      const pedidosContent = document.getElementById("pedidosContent");
      const proveedoresGrid = document.getElementById("proveedoresGrid");
      const pedidosTableBody = document.getElementById("pedidosTableBody");
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const categoryFilter = document.getElementById("categoryFilter");
      const statusFilter = document.getElementById("statusFilter");

      // Modal Elements - Provider
      const providerModal = document.getElementById("providerModal");
      const closeProviderModal = document.getElementById("closeProviderModal");
      const addProviderBtn = document.getElementById("addProviderBtn");
      const providerForm = document.getElementById("providerForm");
      const modalTitle = document.getElementById("modalTitle");
      const providerId = document.getElementById("providerId");
      const providerName = document.getElementById("providerName");
      const providerEmail = document.getElementById("providerEmail");
      const providerPhone = document.getElementById("providerPhone");
      const providerDelivery = document.getElementById("providerDelivery");
      const providerAddress = document.getElementById("providerAddress");
      const providerCity = document.getElementById("providerCity");
      const providerState = document.getElementById("providerState");
      const providerZip = document.getElementById("providerZip");
      const providerNotes = document.getElementById("providerNotes");
      const cancelProviderBtn = document.getElementById("cancelProviderBtn");

      // Modal Elements - Order
      const orderModal = document.getElementById("orderModal");
      const closeOrderModal = document.getElementById("closeOrderModal");
      const addOrderBtn = document.getElementById("addOrderBtn");
      const orderForm = document.getElementById("orderForm");
      const orderProvider = document.getElementById("orderProvider");
      const orderExpectedDate = document.getElementById("orderExpectedDate");
      const orderNotes = document.getElementById("orderNotes");
      const orderDetailsList = document.getElementById("orderDetailsList");
      const orderSubtotal = document.getElementById("orderSubtotal");
      const orderTax = document.getElementById("orderTax");
      const orderTotal = document.getElementById("orderTotal");
      const cancelOrderBtn = document.getElementById("cancelOrderBtn");
      const addProductBtn = document.getElementById("addProductBtn");

      // Modal Elements - Product
      const productModal = document.getElementById("productModal");
      const closeProductModal = document.getElementById("closeProductModal");
      const productForm = document.getElementById("productForm");
      const productSelect = document.getElementById("productSelect");
      const productQuantity = document.getElementById("productQuantity");
      const productPrice = document.getElementById("productPrice");
      const cancelProductBtn = document.getElementById("cancelProductBtn");

      // Modal Elements - Details
      const detailsModal = document.getElementById("detailsModal");
      closeProductModal.addEventListener("click", handleCloseProductModal);
      cancelProductBtn.addEventListener("click", handleCloseProductModal);
      const detailsTitle = document.getElementById("detailsTitle");
      const detailsNumber = document.getElementById("detailsNumber");
      const detailsStatus = document.getElementById("detailsStatus");
      const detailsProvider = document.getElementById("detailsProvider");
      const detailsDate = document.getElementById("detailsDate");
      const detailsNotes = document.getElementById("detailsNotes");
      const detailsProductList = document.getElementById("detailsProductList");
      const detailsSubtotal = document.getElementById("detailsSubtotal");
      const detailsTax = document.getElementById("detailsTax");
      const detailsTotal = document.getElementById("detailsTotal");

      // Event Listeners

      // Tab Navigation
      proveedoresTab.addEventListener("click", () => {
        proveedoresTab.classList.add(
          "text-red-600",
          "after:content-['']",
          "after:absolute",
          "after:w-full",
          "after:h-0.5",
          "after:bg-red-600",
          "after:bottom-0",
          "after:left-0"
        );
        pedidosTab.classList.remove(
          "text-red-600",
          "after:content-['']",
          "after:absolute",
          "after:w-full",
          "after:h-0.5",
          "after:bg-red-600",
          "after:bottom-0",
          "after:left-0"
        );
        proveedoresContent.classList.remove("hidden");
        proveedoresContent.classList.add("block");
        pedidosContent.classList.add("hidden");
      });

      pedidosTab.addEventListener("click", () => {
        pedidosTab.classList.add(
          "text-red-600",
          "after:content-['']",
          "after:absolute",
          "after:w-full",
          "after:h-0.5",
          "after:bg-red-600",
          "after:bottom-0",
          "after:left-0"
        );
        proveedoresTab.classList.remove(
          "text-red-600",
          "after:content-['']",
          "after:absolute",
          "after:w-full",
          "after:h-0.5",
          "after:bg-red-600",
          "after:bottom-0",
          "after:left-0"
        );
        pedidosContent.classList.remove("hidden");
        proveedoresContent.classList.add("hidden");
        loadOrders();
      });

      // Search
      searchBtn.addEventListener("click", () => {
        loadProviders();
      });

      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          loadProviders();
        }
      });

      // Filters
      categoryFilter.addEventListener("change", loadProviders);
      statusFilter.addEventListener("change", loadProviders);

      // Provider Modal
      addProviderBtn.addEventListener("click", openAddProviderModal);
      closeProviderModal.addEventListener("click", closeProviderModals);
      cancelProviderBtn.addEventListener("click", closeProviderModals);
      providerForm.addEventListener("submit", saveProvider);

      // Order Modal
      addOrderBtn.addEventListener("click", openAddOrderModal);
      closeOrderModal.addEventListener("click", closeOrderModals);
      cancelOrderBtn.addEventListener("click", closeOrderModals);
      orderForm.addEventListener("submit", saveOrder);

      // Product Modal
      addProductBtn.addEventListener("click", openAddProductModal);
      closeProductModal.addEventListener("click", closeProductModal);
      cancelProductBtn.addEventListener("click", closeProductModal);
      productForm.addEventListener("submit", addProductToOrder);
      productSelect.addEventListener("change", updateProductPrice);

      // Details Modal
      closeDetailsModal.addEventListener("click", closeDetailsModal);
      closeDetailsBtn.addEventListener("click", closeDetailsModal);

      document.addEventListener("DOMContentLoaded", function () {
        // Aseg√∫rate de que todos los elementos existan antes de asignarles event listeners
        const closeDetailsModal = document.getElementById("closeDetailsModal");
        const closeDetailsBtn = document.getElementById("closeDetailsBtn");

        if (closeDetailsModal) {
          closeDetailsModal.addEventListener("click", function () {
            document.getElementById("detailsModal").classList.add("hidden");
          });
        } else {
          console.error("Elemento 'closeDetailsModal' no encontrado");
        }

        if (closeDetailsBtn) {
          closeDetailsBtn.addEventListener("click", function () {
            document.getElementById("detailsModal").classList.add("hidden");
          });
        }
      });

      // Functions for Providers

      // Load providers from API
      function loadProviders() {
        console.log("Iniciando carga de proveedores...");
        const searchTerm = searchInput.value;
        const statusValue = statusFilter.value;
        const categoryValue = categoryFilter.value;

        console.log("Par√°metros de b√∫squeda:", {
          searchTerm,
          statusValue,
          categoryValue,
        });

        // Build query parameters
        let params = {};
        if (searchTerm) {
          params.search = searchTerm;
        }

        // In a real API, you might have more filters like status and category
        // For demonstration, we'll use mock data

        // API call using axios
        console.log(
          "Enviando solicitud GET a /proveedores con par√°metros:",
          params
        );

        axios
          .get("/proveedores", { params })
          .then((response) => {
            console.log("Respuesta exitosa de proveedores:", response.data);
            currentProviders = response.data;
            console.log("Proveedores procesados:", currentProviders.length);
            renderProviders();
          })
          .catch((error) => {
            console.error("Error cargando proveedores:", error);

            if (error.response) {
              console.error("Detalles del error:", error.response.data);
              console.error("Estado HTTP:", error.response.status);
            } else if (error.request) {
              console.error(
                "No se recibi√≥ respuesta del servidor. Petici√≥n:",
                error.request
              );
            } else {
              console.error("Error al configurar la solicitud:", error.message);
            }

            console.log("Cargando datos de muestra como fallback...");
            currentProviders = getMockProviders();
            console.log(
              "Proveedores de muestra cargados:",
              currentProviders.length
            );
            renderProviders();

            showNotification(
              "Error al cargar proveedores. Usando datos de muestra.",
              "error"
            );
          });
      }

      // Primero necesitas autenticarte para obtener un token
      axios
        .post("http://127.0.0.1:8000/api/auth/token", {
          username: "tu_usuario",
          password: "tu_contrase√±a",
        })
        .then((response) => {
          // Guarda el token que recibas
          const token = response.data.access_token; // O como se llame en tu API

          // Configura Axios para usar este token en futuras peticiones
          axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;

          // Ahora puedes cargar los datos
          loadProviders();
        })
        .catch((error) => {
          console.error("Error al obtener token:", error);
        });

      // Para OAuth2 Password Flow (com√∫n en FastAPI)
      const formData = new FormData();
      formData.append("username", "tu_usuario");
      formData.append("password", "tu_contrase√±a");

      axios
        .post("http://127.0.0.1:8000/api/token", formData, {
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
        })
        .then((response) => {
          const token = response.data.access_token;
          axios.defaults.headers.common["Authorization"] = `Bearer ${token}`;
          loadProviders();
        });

      // Render providers in the grid
      function renderProviders() {
        console.log("Iniciando renderizado de proveedores...");
        console.log(
          "N√∫mero de proveedores a renderizar:",
          currentProviders.length
        );

        proveedoresGrid.innerHTML = "";

        if (currentProviders.length === 0) {
          console.log("No hay proveedores para mostrar.");
          proveedoresGrid.innerHTML = `
                    <div class="col-span-3 p-8 text-center text-gray-500">
                        No se encontraron proveedores. Intenta con otros filtros o agrega uno nuevo.
                    </div>
                `;
          return;
        }

        currentProviders.forEach((provider, index) => {
          console.log(
            `Renderizando proveedor ${index + 1}/${currentProviders.length}:`,
            provider.nombre
          );

          const providerCard = document.createElement("div");
          providerCard.className =
            "bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-md transition transform hover:-translate-y-1";

          // Get first letter of provider name for the logo
          const firstLetter = provider.nombre.charAt(0).toUpperCase();

          providerCard.innerHTML = `
                    <div class="bg-gray-100 p-5 flex items-center gap-4">
                        <div class="w-14 h-14 rounded-lg bg-gray-300 flex items-center justify-center font-bold text-2xl text-gray-600">
                            ${firstLetter}
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg">${
                              provider.nombre
                            }</h3>
                            <div class="text-sm text-gray-600">${getCategoryByName(
                              provider.nombre
                            )}</div>
                        </div>
                    </div>
                    <div class="p-5">
                        <div class="mb-3">
                            <div class="text-xs text-gray-500">Contacto</div>
                            <div class="font-medium">${provider.email}</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-xs text-gray-500">Tel√©fono</div>
                            <div class="font-medium">${
                              provider.telefono || "No especificado"
                            }</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-xs text-gray-500">Tiempo de entrega</div>
                            <div class="font-medium">${
                              provider.tiempo_entrega_promedio
                                ? provider.tiempo_entrega_promedio + " d√≠as"
                                : "No especificado"
                            }</div>
                        </div>
                        <div class="mb-4">
                            <div class="text-xs text-gray-500">Estado</div>
                            <div class="font-medium">${
                              provider.id_status === 1 ? "Activo" : "Inactivo"
                            }</div>
                        </div>
                        <div class="flex gap-2">
                            <button class="flex-1 py-2 px-3 bg-gray-100 text-gray-800 rounded font-medium text-sm hover:bg-gray-200 transition" onclick="editProvider(${
                              provider.id_proveedor
                            })">Editar</button>
                            <button class="flex-1 py-2 px-3 bg-red-50 text-red-700 rounded font-medium text-sm hover:bg-red-100 transition" onclick="deleteProvider(${
                              provider.id_proveedor
                            })">Eliminar</button>
                            <button class="flex-1 py-2 px-3 bg-green-50 text-green-700 rounded font-medium text-sm hover:bg-green-100 transition" onclick="createOrder(${
                              provider.id_proveedor
                            })">Ordenar</button>
                        </div>
                    </div>
                `;

          proveedoresGrid.appendChild(providerCard);
        });

        console.log("Renderizado de proveedores completado.");
      }

      // Open add provider modal
      function openAddProviderModal() {
        console.log("Abriendo modal para a√±adir producto...");
        modalTitle.textContent = "Agregar Proveedor";
        providerId.value = "";
        providerForm.reset();
        providerModal.classList.remove("hidden");
      }

      // Open edit provider modal
      function editProvider(id) {
        const provider = currentProviders.find((p) => p.id_proveedor === id);
        if (!provider) return;

        modalTitle.textContent = "Editar Proveedor";
        providerId.value = provider.id_proveedor;
        providerName.value = provider.nombre;
        providerEmail.value = provider.email;
        providerPhone.value = provider.telefono || "";
        providerDelivery.value = provider.tiempo_entrega_promedio || "";
        providerAddress.value = provider.direccion || "";
        providerCity.value = provider.ciudad || "";
        providerState.value = provider.estado || "";
        providerZip.value = provider.codigo_postal || "";
        providerNotes.value = provider.notas || "";

        providerModal.classList.remove("hidden");
      }

      // Save provider (create or update)
      function saveProvider(e) {
        e.preventDefault();
        console.log("Iniciando guardado de proveedor...");

        const id = providerId.value;
        const providerData = {
          nombre: providerName.value,
          email: providerEmail.value,
          telefono: providerPhone.value,
          tiempo_entrega_promedio: providerDelivery.value
            ? parseInt(providerDelivery.value)
            : null,
          direccion: providerAddress.value,
          ciudad: providerCity.value,
          estado: providerState.value,
          codigo_postal: providerZip.value,
          notas: providerNotes.value,
        };

        console.log("Datos del proveedor a guardar:", providerData);
        console.log("ID del proveedor (si es edici√≥n):", id);

        if (id) {
          // Update existing provider

          console.log(`Actualizando proveedor existente con ID ${id}...`);
          axios
            .put(`/proveedores/${id}`, providerData)
            .then((response) => {
              console.log("Proveedor actualizado exitosamente:", response.data);
              showNotification(
                "Proveedor actualizado correctamente",
                "success"
              );
              closeProviderModals();
              loadProviders();
            })
            .catch((error) => {
              console.error("Error actualizando proveedor:", error);
              if (error.response) {
                console.error("Detalles del error:", error.response.data);
                console.error("Estado HTTP:", error.response.status);
              }
              showNotification(
                "Error al actualizar proveedor: " +
                  (error.response?.data?.detail || error.message),
                "error"
              );
            });
        } else {
          // Create new provider
          console.log("Creando nuevo proveedor...");
          axios
            .post("/proveedores", providerData)
            .then((response) => {
              console.log("Proveedor creado exitosamente:", response.data);
              showNotification("Proveedor creado correctamente", "success");
              closeProviderModals();
              loadProviders();
            })
            .catch((error) => {
              console.error("Error creando proveedor:", error);
              if (error.response) {
                console.error("Detalles del error:", error.response.data);
                console.error("Estado HTTP:", error.response.status);
              }
              showNotification("Error al crear proveedor", "error");
            });
        }
      }

      // Delete provider
      function deleteProvider(id) {
        if (!confirm("¬øEst√° seguro que desea eliminar este proveedor?")) return;

        axios
          .delete(`/proveedores/${id}`)
          .then((response) => {
            showNotification("Proveedor eliminado correctamente", "success");
            loadProviders();
          })
          .catch((error) => {
            console.error("Error deleting provider:", error);
            showNotification("Error al eliminar proveedor", "error");
          });
      }

      // Close provider modals
      function closeProviderModals() {
        providerModal.classList.add("hidden");
      }

      // Functions for Orders

      // Load orders from API
      function loadOrders() {
        axios
          .get("/compras")
          .then((response) => {
            currentOrders = response.data;
            renderOrders();
          })
          .catch((error) => {
            console.error("Error loading orders:", error);

            // For demonstration, load mock data
            currentOrders = getMockOrders();
            renderOrders();

            showNotification(
              "Error al cargar pedidos. Usando datos de muestra.",
              "error"
            );
          });
      }

      // Render orders in the table
      function renderOrders() {
        pedidosTableBody.innerHTML = "";

        if (currentOrders.length === 0) {
          pedidosTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-sm text-gray-500 text-center">
                            No se encontraron pedidos. Intenta crear uno nuevo.
                        </td>
                    </tr>
                `;
          return;
        }

        currentOrders.forEach((order) => {
          const provider = currentProviders.find(
            (p) => p.id_proveedor === order.id_proveedor
          ) || { nombre: "Proveedor no encontrado" };

          const orderRow = document.createElement("tr");

          let statusClass = "";
          let statusLabel = "";

          switch (order.estado) {
            case "pendiente":
              statusClass = "bg-yellow-100 text-yellow-800";
              statusLabel = "Pendiente";
              break;
            case "procesado":
              statusClass = "bg-blue-100 text-blue-800";
              statusLabel = "Procesado";
              break;
            case "entregado":
              statusClass = "bg-green-100 text-green-800";
              statusLabel = "Entregado";
              break;
            case "cancelado":
              statusClass = "bg-red-100 text-red-800";
              statusLabel = "Cancelado";
              break;
            default:
              statusClass = "bg-gray-100 text-gray-800";
              statusLabel = order.estado;
          }

          orderRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${order.numero_compra}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${provider.nombre}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatDate(order.fecha_orden)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        $${order.total.toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusLabel}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button class="text-blue-600 hover:text-blue-900 mr-3" onclick="viewOrderDetails(${
                          order.id_compra
                        })">
                            Ver
                        </button>
                        ${
                          order.estado === "pendiente"
                            ? `
                            <button class="text-red-600 hover:text-red-900" onclick="cancelOrder(${order.id_compra})">
                                Cancelar
                            </button>
                        `
                            : ""
                        }
                    </td>
                `;

          pedidosTableBody.appendChild(orderRow);
        });
      }

      // Initialize order creation
      function createOrder(providerId) {
        selectedProviderId = providerId;
        openAddOrderModal();
      }
      // Open add order modal
      function openAddOrderModal() {
        orderDetailsList.innerHTML = `
                <tr id="noProductsRow">
                    <td colspan="5" class="px-4 py-3 text-sm text-gray-500 text-center">No hay productos agregados</td>
                </tr>
            `;

        orderForm.reset();
        orderDetails = [];
        updateOrderTotals();

        // Load providers for the dropdown
        orderProvider.innerHTML =
          '<option value="">Seleccionar proveedor</option>';

        // If we don't have providers loaded yet, load them
        if (currentProviders.length === 0) {
          loadProviders();
        }

        currentProviders.forEach((provider) => {
          const option = document.createElement("option");
          option.value = provider.id_proveedor;
          option.textContent = provider.nombre;
          orderProvider.appendChild(option);
        });

        // If a provider was selected (from the provider card)
        if (selectedProviderId) {
          orderProvider.value = selectedProviderId;
        }

        // Load products for the product modal
        loadProducts();

        orderModal.classList.remove("hidden");
      }

      // Load products for order
      function loadProducts() {
        axios
          .get("/productos")
          .then((response) => {
            currentProducts = response.data;
            updateProductsDropdown();
          })
          .catch((error) => {
            console.error("Error loading products:", error);

            // For demonstration, load mock data
            currentProducts = getMockProducts();
            updateProductsDropdown();

            showNotification(
              "Error al cargar productos. Usando datos de muestra.",
              "error"
            );
          });
      }

      // Update products dropdown
      function updateProductsDropdown() {
        productSelect.innerHTML =
          '<option value="">Seleccionar producto</option>';

        currentProducts.forEach((product) => {
          const option = document.createElement("option");
          option.value = product.id_producto;
          option.textContent = `${product.nombre} (SKU: ${product.sku})`;
          option.dataset.price = product.precio_compra;
          productSelect.appendChild(option);
        });
      }

      // Open add product modal
      function openAddProductModal() {
        console.log("Abriendo modal para a√±adir producto...");
        productForm.reset();
        productModal.classList.remove("hidden");
      }

      function handleCloseProductModal() {
        console.log("Cerrando modal de productos...");
        productModal.classList.add("hidden");
      }

      // Update product price based on selected product
      function updateProductPrice() {
        const selectedOption =
          productSelect.options[productSelect.selectedIndex];
        if (selectedOption && selectedOption.dataset.price) {
          productPrice.value = selectedOption.dataset.price;
        } else {
          productPrice.value = "";
        }
      }

      // Add product to order
      function addProductToOrder(e) {
        e.preventDefault();

        const productId = productSelect.value;
        if (!productId) {
          showNotification("Debes seleccionar un producto", "error");
          return;
        }

        const quantity = parseInt(productQuantity.value);
        const price = parseFloat(productPrice.value);

        if (isNaN(quantity) || quantity <= 0) {
          showNotification("La cantidad debe ser mayor a 0", "error");
          return;
        }

        if (isNaN(price) || price <= 0) {
          showNotification("El precio debe ser mayor a 0", "error");
          return;
        }

        const product = currentProducts.find(
          (p) => p.id_producto.toString() === productId
        );
        if (!product) {
          showNotification("Producto no encontrado", "error");
          return;
        }

        // Check if product already exists in order
        const existingProductIndex = orderDetails.findIndex(
          (item) => item.id_producto.toString() === productId
        );

        if (existingProductIndex !== -1) {
          // Update existing product
          orderDetails[existingProductIndex].cantidad_ordenada += quantity;
          orderDetails[existingProductIndex].precio_unitario = price;
          orderDetails[existingProductIndex].subtotal =
            orderDetails[existingProductIndex].cantidad_ordenada * price;
        } else {
          // Add new product
          orderDetails.push({
            id_producto: parseInt(productId),
            producto: product,
            cantidad_ordenada: quantity,
            precio_unitario: price,
            subtotal: quantity * price,
          });
        }

        renderOrderDetails();
        updateOrderTotals();
        closeProductModal();
      }

      // Render order details
      function renderOrderDetails() {
        if (orderDetails.length === 0) {
          orderDetailsList.innerHTML = `
                    <tr id="noProductsRow">
                        <td colspan="5" class="px-4 py-3 text-sm text-gray-500 text-center">No hay productos agregados</td>
                    </tr>
                `;
          return;
        }

        orderDetailsList.innerHTML = "";

        orderDetails.forEach((detail, index) => {
          const detailRow = document.createElement("tr");

          detailRow.innerHTML = `
                    <td class="px-4 py-3 text-sm">
                        ${detail.producto.nombre}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        ${detail.cantidad_ordenada}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        $${detail.precio_unitario.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        $${detail.subtotal.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button type="button" class="text-red-600 hover:text-red-900" onclick="removeOrderDetail(${index})">
                            Eliminar
                        </button>
                    </td>
                `;

          orderDetailsList.appendChild(detailRow);
        });
      }

      // Remove product from order
      function removeOrderDetail(index) {
        orderDetails.splice(index, 1);
        renderOrderDetails();
        updateOrderTotals();
      }

      // Update order totals
      function updateOrderTotals() {
        let subtotal = 0;

        orderDetails.forEach((detail) => {
          subtotal += detail.subtotal;
        });

        const tax = subtotal * 0.16;
        const total = subtotal + tax;

        orderSubtotal.textContent = `$${subtotal.toFixed(2)}`;
        orderTax.textContent = `$${tax.toFixed(2)}`;
        orderTotal.textContent = `$${total.toFixed(2)}`;
      }

      // Save order
      function saveOrder(e) {
        e.preventDefault();

        const providerId = orderProvider.value;
        if (!providerId) {
          showNotification("Debes seleccionar un proveedor", "error");
          return;
        }

        if (orderDetails.length === 0) {
          showNotification("Debes agregar al menos un producto", "error");
          return;
        }

        const orderData = {
          id_proveedor: parseInt(providerId),
          fecha_estimada_llegada: orderExpectedDate.value || null,
          detalles: orderDetails.map((detail) => ({
            id_producto: detail.id_producto,
            cantidad_ordenada: detail.cantidad_ordenada,
            precio_unitario: detail.precio_unitario,
            subtotal: detail.subtotal,
          })),
          notas: orderNotes.value,
        };

        axios
          .post("/compras", orderData)
          .then((response) => {
            showNotification("Pedido creado correctamente", "success");
            closeOrderModals();
            loadOrders();
            selectedProviderId = null;
          })
          .catch((error) => {
            console.error("Error creating order:", error);

            // For demonstration, we'll simulate a successful order
            showNotification(
              "Simulando creaci√≥n de pedido (modo demo)",
              "success"
            );
            closeOrderModals();

            // Add new order to mock data
            const newOrder = {
              id_compra: Math.floor(Math.random() * 1000) + 100,
              numero_compra: `PED-${new Date()
                .getTime()
                .toString()
                .substr(-8)}`,
              id_proveedor: parseInt(providerId),
              fecha_orden: new Date().toISOString(),
              fecha_estimada_llegada: orderExpectedDate.value || null,
              subtotal: parseFloat(orderSubtotal.textContent.replace("$", "")),
              impuestos: parseFloat(orderTax.textContent.replace("$", "")),
              total: parseFloat(orderTotal.textContent.replace("$", "")),
              estado: "pendiente",
              notas: orderNotes.value,
            };

            currentOrders.unshift(newOrder);
            renderOrders();
            selectedProviderId = null;
          });
      }

      // View order details
      function viewOrderDetails(orderId) {
        const order = currentOrders.find((o) => o.id_compra === orderId);
        if (!order) return;

        const provider = currentProviders.find(
          (p) => p.id_proveedor === order.id_proveedor
        ) || { nombre: "Proveedor no encontrado" };

        detailsTitle.textContent = `Detalles del Pedido #${order.id_compra}`;
        detailsNumber.textContent = order.numero_compra;

        let statusLabel = "";
        switch (order.estado) {
          case "pendiente":
            statusLabel = "Pendiente";
            break;
          case "procesado":
            statusLabel = "Procesado";
            break;
          case "entregado":
            statusLabel = "Entregado";
            break;
          case "cancelado":
            statusLabel = "Cancelado";
            break;
          default:
            statusLabel = order.estado;
        }

        detailsStatus.textContent = statusLabel;
        detailsProvider.textContent = provider.nombre;
        detailsDate.textContent = formatDate(order.fecha_orden);
        detailsNotes.textContent = order.notas || "Sin notas";

        // For demonstration purposes, generate mock details
        const mockDetails = getMockOrderDetails(order.id_compra);

        detailsProductList.innerHTML = "";

        mockDetails.forEach((detail) => {
          const product = currentProducts.find(
            (p) => p.id_producto === detail.id_producto
          ) || { nombre: "Producto no encontrado" };

          const detailRow = document.createElement("tr");
          detailRow.innerHTML = `
                    <td class="px-4 py-3 text-sm">
                        ${product.nombre}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        ${detail.cantidad_ordenada}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        $${detail.precio_unitario.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        $${detail.subtotal.toFixed(2)}
                    </td>
                `;

          detailsProductList.appendChild(detailRow);
        });

        detailsSubtotal.textContent = `$${order.subtotal.toFixed(2)}`;
        detailsTax.textContent = `$${order.impuestos.toFixed(2)}`;
        detailsTotal.textContent = `$${order.total.toFixed(2)}`;

        detailsModal.classList.remove("hidden");
      }

      // Cancel order
      function cancelOrder(orderId) {
        if (!confirm("¬øEst√° seguro que desea cancelar este pedido?")) return;

        axios
          .post(`/compras/${orderId}/cancelar`)
          .then((response) => {
            showNotification("Pedido cancelado correctamente", "success");
            loadOrders();
          })
          .catch((error) => {
            console.error("Error canceling order:", error);

            // For demonstration, we'll simulate a successful cancellation
            const orderIndex = currentOrders.findIndex(
              (o) => o.id_compra === orderId
            );
            if (orderIndex !== -1) {
              currentOrders[orderIndex].estado = "cancelado";
              renderOrders();
              showNotification(
                "Pedido cancelado correctamente (modo demo)",
                "success"
              );
            }
          });
      }

      // Close order modals
      function closeOrderModals() {
        orderModal.classList.add("hidden");
      }

      // Close product modal
      function handleCloseProductModal() {
        console.log("Cerrando modal de productos...");
        productModal.classList.add("hidden");
      }

      // Close details modal
      function closeDetailsModal() {
        detailsModal.classList.add("hidden");
      }

      // Helper Functions

      // Format date
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("es-MX", {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Determine category by name (for demo)
      function getCategoryByName(name) {
        name = name.toLowerCase();
        if (name.includes("marvel") || name.includes("dc")) return "Comics";
        if (
          name.includes("manga") ||
          name.includes("anime") ||
          name.includes("jump")
        )
          return "Manga";
        if (name.includes("funko") || name.includes("merch"))
          return "Merchandising";
        return "Otros";
      }

      // Show notification
      function showNotification(message, type = "success") {
        console.log(`NOTIFICACI√ìN [${type}]: ${message}`);
        if (type === "error") {
          alert(`ERROR: ${message}`);
        } else {
          alert(`√âXITO: ${message}`);
        }
      }

      // Mock Data for demo

      function getMockProviders() {
        return [
          {
            id_proveedor: 1,
            nombre: "Marvel Comics",
            email: "john.smith@marvel.com",
            telefono: "+1 (555) 123-4567",
            direccion: "10 Marvel Way",
            ciudad: "New York",
            estado: "NY",
            codigo_postal: "10001",
            notas: "Proveedor principal de comics Marvel",
            tiempo_entrega_promedio: 7,
            id_status: 1,
          },
          {
            id_proveedor: 2,
            nombre: "DC Comics",
            email: "jane.doe@dc.com",
            telefono: "+1 (555) 987-6543",
            direccion: "1700 Broadway",
            ciudad: "New York",
            estado: "NY",
            codigo_postal: "10019",
            notas: "Proveedor principal de comics DC",
            tiempo_entrega_promedio: 8,
            id_status: 1,
          },
          {
            id_proveedor: 3,
            nombre: "Shonen Jump",
            email: "t.yamamoto@shonenjump.jp",
            telefono: "+81 3-1234-5678",
            direccion: "2-5-10 Hitotsubashi",
            ciudad: "Tokio",
            estado: "",
            codigo_postal: "100-8050",
            notas: "Proveedor principal de manga",
            tiempo_entrega_promedio: 15,
            id_status: 1,
          },
          {
            id_proveedor: 4,
            nombre: "Planeta Comics",
            email: "c.rodriguez@planeta.es",
            telefono: "+34 91 123 45 67",
            direccion: "Av. Diagonal, 662-664",
            ciudad: "Barcelona",
            estado: "",
            codigo_postal: "08034",
            notas: "Distribuidor espa√±ol de comics",
            tiempo_entrega_promedio: 12,
            id_status: 1,
          },
          {
            id_proveedor: 5,
            nombre: "Funko Merch",
            email: "mike.j@funko.com",
            telefono: "+1 (555) 456-7890",
            direccion: "2802 Wetmore Ave",
            ciudad: "Everett",
            estado: "WA",
            codigo_postal: "98201",
            notas: "Figuras Funko Pop y merchandising",
            tiempo_entrega_promedio: 10,
            id_status: 1,
          },
          {
            id_proveedor: 6,
            nombre: "Panini M√©xico",
            email: "a.martinez@panini.mx",
            telefono: "+52 55 1234 5678",
            direccion: "Av. Patriotismo 635",
            ciudad: "Ciudad de M√©xico",
            estado: "CDMX",
            codigo_postal: "03710",
            notas: "Distribuidor oficial de comics y mangas en M√©xico",
            tiempo_entrega_promedio: 5,
            id_status: 1,
          },
        ];
      }

      function getMockOrders() {
        return [
          {
            id_compra: 1,
            numero_compra: "PED-20230415-A1B2C",
            id_proveedor: 1,
            fecha_orden: "2023-04-15T10:30:00",
            fecha_estimada_llegada: "2023-04-22",
            fecha_recepcion: null,
            subtotal: 5000,
            impuestos: 800,
            total: 5800,
            estado: "pendiente",
            id_empleado: 1,
            notas: "Pedido de nuevos lanzamientos Marvel",
          },
          {
            id_compra: 2,
            numero_compra: "PED-20230410-X7Y8Z",
            id_proveedor: 2,
            fecha_orden: "2023-04-10T14:20:00",
            fecha_estimada_llegada: "2023-04-18",
            fecha_recepcion: "2023-04-17",
            subtotal: 3500,
            impuestos: 560,
            total: 4060,
            estado: "entregado",
            id_empleado: 1,
            notas: "Pedido mensual DC Comics",
          },
          {
            id_compra: 3,
            numero_compra: "PED-20230405-D4E5F",
            id_proveedor: 3,
            fecha_orden: "2023-04-05T09:15:00",
            fecha_estimada_llegada: "2023-04-20",
            fecha_recepcion: null,
            subtotal: 4200,
            impuestos: 672,
            total: 4872,
            estado: "procesado",
            id_empleado: 2,
            notas: "Pedido trimestral de mangas",
          },
          {
            id_compra: 4,
            numero_compra: "PED-20230401-G7H8I",
            id_proveedor: 5,
            fecha_orden: "2023-04-01T11:45:00",
            fecha_estimada_llegada: "2023-04-11",
            fecha_recepcion: null,
            subtotal: 2800,
            impuestos: 448,
            total: 3248,
            estado: "cancelado",
            id_empleado: 1,
            notas: "Pedido figuritas Funko - Cancelado por falta de stock",
          },
        ];
      }

      function getMockProducts() {
        return [
          {
            id_producto: 1,
            sku: "BAT-001",
            nombre: "Batman: A√±o Uno",
            descripcion: "Comic Batman A√±o Uno",
            id_categoria: 1,
            stock_actual: 15,
            stock_minimo: 5,
            precio_compra: 150.0,
            precio_venta: 299.99,
            fecha_lanzamiento: "1986-02-01",
            imagen_url: "batman.jpg",
            id_proveedor: 2,
            id_status: 1,
          },
          {
            id_producto: 2,
            sku: "SPM-001",
            nombre: "Spider-Man: No Way Home",
            descripcion: "Comic Spider-Man No Way Home",
            id_categoria: 1,
            stock_actual: 8,
            stock_minimo: 3,
            precio_compra: 180.0,
            precio_venta: 349.99,
            fecha_lanzamiento: "2021-12-01",
            imagen_url: "spiderman.jpg",
            id_proveedor: 1,
            id_status: 1,
          },
          {
            id_producto: 3,
            sku: "WCM-001",
            nombre: "Watchmen",
            descripcion: "Comic Watchmen",
            id_categoria: 1,
            stock_actual: 5,
            stock_minimo: 2,
            precio_compra: 250.0,
            precio_venta: 499.99,
            fecha_lanzamiento: "1986-09-01",
            imagen_url: "watchmen.jpg",
            id_proveedor: 2,
            id_status: 1,
          },
          {
            id_producto: 4,
            sku: "OPC-098",
            nombre: "One Piece Vol. 98",
            descripcion: "Manga One Piece Volumen 98",
            id_categoria: 2,
            stock_actual: 20,
            stock_minimo: 5,
            precio_compra: 100.0,
            precio_venta: 199.99,
            fecha_lanzamiento: "2021-02-01",
            imagen_url: "onepiece.jpg",
            id_proveedor: 3,
            id_status: 1,
          },
          {
            id_producto: 5,
            sku: "DSL-010",
            nombre: "Demon Slayer Vol. 10",
            descripcion: "Manga Demon Slayer Volumen 10",
            id_categoria: 2,
            stock_actual: 12,
            stock_minimo: 3,
            precio_compra: 95.0,
            precio_venta: 189.99,
            fecha_lanzamiento: "2020-01-01",
            imagen_url: "demonslayer.jpg",
            id_proveedor: 3,
            id_status: 1,
          },
          {
            id_producto: 7,
            sku: "FNK-001",
            nombre: "Funko Pop Iron Man",
            descripcion: "Figura Funko Pop Iron Man",
            id_categoria: 3,
            stock_actual: 10,
            stock_minimo: 3,
            precio_compra: 175.0,
            precio_venta: 349.99,
            fecha_lanzamiento: "2018-05-01",
            imagen_url: "funko.jpg",
            id_proveedor: 5,
            id_status: 1,
          },
        ];
      }

      function getMockOrderDetails(orderId) {
        const products = getMockProducts();

        // Generate random details based on order ID
        const numProducts = Math.floor(Math.random() * 4) + 1; // 1-4 products
        const details = [];

        for (let i = 0; i < numProducts; i++) {
          const randomProduct =
            products[Math.floor(Math.random() * products.length)];
          const quantity = Math.floor(Math.random() * 10) + 1; // 1-10 quantity
          const price = randomProduct.precio_compra;

          details.push({
            id_detalle: i + 1,
            id_compra: orderId,
            id_producto: randomProduct.id_producto,
            cantidad_ordenada: quantity,
            cantidad_recibida: 0,
            precio_unitario: price,
            subtotal: price * quantity,
            estado: "pendiente",
          });
        }

        return details;
      }

      // Initialize application
      loadProviders();
    </script>
  </body>
</html>
